<div class="columns is-gap-1">
  <div class="column is-narrow has-border-right">
    <%= render "layouts/sidebar" %>
  </div>
  <div class="column is-10">
    <nav class="level">
      <div class="level-left">
        <div class="level-item">
          <%= search_form_for @q, class: "field has-addons" do |f| %>
            <p class="control has-icons-left">
              <%= f.search_field :title_or_extracted_code_cont,
                                class: "input", 
                                placeholder: "Знайти по автору або ІПН" %>
              <span class="icon is-small is-left">
                <i class="fa-solid fa-magnifying-glass"></i>
              </span>
            </p>
            <p class="control"><%= f.submit "Пошук", class: "button" %></p>
          <% end %>
        </div>

        <%= link_to new_document_path, class: "button is-primary" do %>
          <span class="icon is-small">
            <i class="fa-solid fa-arrow-up-from-bracket"></i>
          </span>
          <span>Завантажити документи</span>
        <% end %>

        <button
          class="button is-success"
          id="sign-selected-documents"
          data-checkbox-target="signButton"
          data-action="click->checkbox#sendSignRequest"
          disabled
        >
          <span class="icon is-small">
            <i class="fas fa-signature"></i>
          </span>
          <span>Відправити на підпис</span>
        </button>
      </div>
    </nav>

    <nav class="level">
      <div class="level-left is-align-items-baseline">
        <div class="level-item">
          <div class="buttons has-addons mb-4">
            <%= link_to "Всі",
                        documents_path(params.permit(:q).merge(status: nil)),
                        class: "button is-small #{"is-link" if params[:status].blank?}" %>
            <%= link_to "Є автор",
                        documents_path(params.permit(:q).merge(status: "linked")),
                        class: "button is-small #{"is-success is-selected" if params[:status] == "linked"}" %>
            <%= link_to "Без автора",
                        documents_path(params.permit(:q).merge(status: "unlinked")),
                        class: "button is-small #{"is-danger is-selected" if params[:status] == "unlinked"}" %>
          </div>
        </div>
      </div>
      <div class="level-right">
        <div class="level-item">
          <p class="subtitle is-6">
            Документів обрано:
            <strong><span id="selected-count" data-checkbox-target="selectedCount">0</span></strong>
          </p>
        </div>
      </div>
    </nav>

    <turbo-frame id="documents_table" data-controller="checkbox">
      <div class="table-container">
        <table class="table is-fullwidth is-hoverable is-narrow">
          <thead>
            <tr class="is-size-6">
              <th>
                <input
                  type="checkbox"
                  id="select-all-documents"
                  data-checkbox-target="selectAll"
                  data-action="change->checkbox#toggleAll"
                >
              </th>
              <th class="has-text-black" has-text-black>
                <%= sort_link(@q, :title, "Назва") %>
              </th>
              <th class="has-text-black" has-text-black>
                <%= sort_link(@q, :status, "Статус") %>
              </th>
              <th class="has-text-black" has-text-black>
                <%= sort_link(@q, :author_name, "Автор") %>
              </th>
              <th class="has-text-black" has-text-black>
                <%= sort_link(@q, :extracted_code, "ІПН") %>
              </th>
              <th class="has-text-black" has-text-black>
                <%= sort_link(@q, :uploaded_by_name, "Завантажив") %>
              </th>
              <th class="has-text-black" has-text-black>
                <%= sort_link(@q, :created_at, "Додано") %>
              </th>
              <th class="has-text-black" has-text-black>
                <%= sort_link(@q, :signed_at, "Підписано") %>
              </th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @documents.each do |doc| %>
              <tr class="<%= 'has-background-warning-light' if doc.status == 'unlinked' %>">
                <td>
                  <input
                    type="checkbox"
                    class="document-checkbox"
                    value="<%= doc.id %>"
                    data-checkbox-target="checkbox"
                    data-action="change->checkbox#toggleCheckbox"
                  >
                </td>
                <td>
                  <%= link_to doc.file.filename, rails_blob_url(doc.file, disposition: 'attachment') if doc.file.attached? %>
                </td>
                <td>
                  <span class="tag <%= status_tag_class(doc.status) %> has-text-dark"><%= doc.status_label %></span>
                </td>
                <td><%= doc.author&.name || "-" %></td>
                <td><%= doc.extracted_code || "-" %></td>
                <td><%= doc.uploaded_by&.name || "-" %></td>
                <td><%= doc.created_at.strftime("%Y/%m/%d") %></td>
                <td><%= doc.signed_at&.strftime("%Y/%m/%d") || "-" %></td>
                <td>
                  <div
                    class="dropdown dropdown-table is-right"
                    data-controller="dropdown"
                  >
                    <div class="dropdown-trigger">
                      <button
                        class="button is-small"
                        aria-haspopup="true"
                        aria-controls="dropdown-table-menu"
                        data-action="click->dropdown#toggle"
                      >
                        <span class="icon is-small">
                          <i class="fas fa-ellipsis-v" aria-hidden="true"></i>
                        </span>
                      </button>
                    </div>
                    <div
                      class="dropdown-menu"
                      id="dropdown-table-menu"
                      role="menu"
                      data-dropdown-target="menu"
                    >
                      <div class="dropdown-content">
                        <% if doc.file.attached? %>
                          <%= link_to rails_blob_path(doc.file, disposition: "attachment"), class: "dropdown-item" do %>
                            <span class="icon is-small">
                              <i class="fas fa-download" aria-hidden="true"></i>
                            </span>
                            <span>Завантажити</span>
                          <% end %>
                        <% end %>

                        <%= link_to edit_document_path(doc), class: "dropdown-item" do %>
                          <span class="icon is-small">
                            <i class="fas fa-edit" aria-hidden="true"></i>
                          </span>
                          <span>Редагувати</span>
                        <% end %>

                        <a
                          href="#"
                          class="dropdown-item"
                          data-controller="modal"
                          data-action="click->modal#open"
                          data-modal-id="delete-modal-<%= doc.id %>"
                        >
                          <span class="icon is-small">
                            <i class="fas fa-trash-alt" aria-hidden="true"></i>
                          </span>
                          <span>Видалити</span>
                        </a>
                      </div>
                    </div>
                  </div>

                  <div
                    id="delete-modal-<%= doc.id %>"
                    class="modal"
                    data-controller="modal"
                  >
                    <div
                      class="modal-background"
                      data-action="click->modal#close"
                    ></div>
                    <div class="modal-card">
                      <header class="modal-card-head">
                        <p class="modal-card-title">
                          Підтвердіть видалення файла
                        </p>
                        <button
                          class="delete"
                          aria-label="Submit document deletion and close"
                          data-action="click->modal#close"
                        ></button>
                      </header>

                      <section class="modal-card-body">
                        Ви впевнені, що хочете видалити документ
                        <strong><%= doc.title %></strong>
                        ?
                      </section>

                      <footer class="modal-card-foot">
                        <div class="buttons">
                          <%= button_to "Так, видалити",
                      document_path(doc),
                      method: :delete,
                      class: "button is-danger" %>
                          <button
                            class="button"
                            data-action="click->modal#close"
                          >
                            Скасувати
                          </button>
                        </div>
                      </footer>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <% if @pagy.pages > 1 %>
        <%== pagy_nav(@pagy) %>
      <% end %>
    </turbo-frame>
  </div>
</div>
